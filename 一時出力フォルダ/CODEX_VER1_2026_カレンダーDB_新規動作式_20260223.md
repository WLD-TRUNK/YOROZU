# CODEX_VER1_2026 カレンダーDB 新規動作式（再作成 2026-02-23）

対象:
- DB: `カテゴリー別集計DB`
- プロパティ: `予算` (formula)

要件:
- 今週の `W` は青
- `W` の横ラベルは `残` / `過` のどちらか1つ
- 超過時の `🎟️` / `💎` の値は赤
- 超過時 `🎟️` は 0 を出さず最低 1 表示
- 凡例は `（超過🎟️/💎）` で `超過` だけ赤

実環境読取確認（2026-02-23 / 変更なし）:
- ルート: `Notion家計簿【2026年最新版】` (`2f2d8928-02b6-8098-b6e4-c96afa72c460`)
- DB: `カテゴリー別集計DB` (`2f2d8928-02b6-81c9-a0d5-e9c6b64fb352`)
- 正式プロパティ: `予算` (`id: D%5EC%3C`)
  - `overT1..6` は「超過時 最低1枚」補正入り
  - 超過値 `🎟️/💎` は `style(..., "red", "b")`
  - 食費行（`2f2d8928-02b6-818d-9aaa-eb0780915ea0`）の実測出力: `W4  過 🎟️1  💎0`
- 旧式プロパティ: `??` (`id: l_IP`) が残存
  - 食費行で `W4  過 🎟️0  💎0` を返す古い式
  - 誤認防止のため、参照対象は `予算 (D%5EC%3C)` のみとする

```notion-formula
lets(
  outcome, prop("中間DB").at(0).prop("支出一覧"),
  y, replaceAll(format(prop("選択年").at(0)), "[^0-9]", ""),
  mNum, toNumber(replaceAll(format(prop("選択月").at(0)), "[^0-9]", "")),
  mText, if(mNum == 0, "", if(mNum < 10, "0" + format(mNum), format(mNum))),
  budget, if(empty(prop("週予算")), 0, prop("週予算")),
  bar, style("　", prop("背景色")),
  scale, 10,

  ym, y + "-" + mText,
  febYm, y + "-02",
  monthStart, parseDate(ym + "-01"),
  offsetSun, if(toNumber(formatDate(monthStart, "E")) == 7, 0, toNumber(formatDate(monthStart, "E"))),
  week0StartM, dateSubtract(monthStart, offsetSun, "days"),
  nextMonthStart, dateAdd(monthStart, 1, "months"),
  monthEnd, dateSubtract(nextMonthStart, 1, "days"),
  weekCount, floor(dateBetween(monthEnd, week0StartM, "days") / 7) + 1,

  nowD, now(),
  nowMonthStart, dateSubtract(nowD, toNumber(formatDate(nowD, "D")) - 1, "days"),
  nowOffsetSun, if(toNumber(formatDate(nowMonthStart, "E")) == 7, 0, toNumber(formatDate(nowMonthStart, "E"))),
  nowWeek0Start, dateSubtract(nowMonthStart, nowOffsetSun, "days"),
  wNow, floor(dateBetween(nowD, nowWeek0Start, "days") / 7) + 1,
  activeW, if(formatDate(nowD, "YYYY-MM") == ym, wNow, 0),

  w1, outcome.filter(
    formatDate(current.prop("日付"), "YYYY-MM") == ym
    and current.prop("カテゴリー") == prop("名前")
    and lets(
      d, current.prop("日付"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 1
  ).map(current.prop("支出")).sum(),

  w2, outcome.filter(
    formatDate(current.prop("日付"), "YYYY-MM") == ym
    and current.prop("カテゴリー") == prop("名前")
    and lets(
      d, current.prop("日付"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 2
  ).map(current.prop("支出")).sum(),

  w3, outcome.filter(
    formatDate(current.prop("日付"), "YYYY-MM") == ym
    and current.prop("カテゴリー") == prop("名前")
    and lets(
      d, current.prop("日付"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 3
  ).map(current.prop("支出")).sum(),

  w4, outcome.filter(
    formatDate(current.prop("日付"), "YYYY-MM") == ym
    and current.prop("カテゴリー") == prop("名前")
    and lets(
      d, current.prop("日付"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 4
  ).map(current.prop("支出")).sum(),

  w5, outcome.filter(
    formatDate(current.prop("日付"), "YYYY-MM") == ym
    and current.prop("カテゴリー") == prop("名前")
    and lets(
      d, current.prop("日付"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 5
  ).map(current.prop("支出")).sum(),

  w6, outcome.filter(
    formatDate(current.prop("日付"), "YYYY-MM") == ym
    and current.prop("カテゴリー") == prop("名前")
    and lets(
      d, current.prop("日付"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 6
  ).map(current.prop("支出")).sum(),

  febW1, if(
    mNum == 1,
    outcome.filter(
      formatDate(current.prop("日付"), "YYYY-MM") == febYm
      and current.prop("カテゴリー") == prop("名前")
      and lets(
        d, current.prop("日付"),
        monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
        offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
        week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
        floor(dateBetween(d, week0Start, "days") / 7) + 1
      ) == 1
    ).map(current.prop("支出")).sum(),
    0
  ),

  w4Adj, if(mNum == 1 and weekCount == 4, w4 + febW1, w4),
  w5Adj, if(mNum == 1 and weekCount == 5, w5 + febW1, w5),
  w6Adj, if(mNum == 1 and weekCount == 6, w6 + febW1, w6),

  r1, budget - w1,
  r2, budget - w2,
  r3, budget - w3,
  r4, budget - w4Adj,
  r5, budget - w5Adj,
  r6, budget - w6Adj,

  over1, if(r1 < 0, -r1, 0),
  over2, if(r2 < 0, -r2, 0),
  over3, if(r3 < 0, -r3, 0),
  over4, if(r4 < 0, -r4, 0),
  over5, if(r5 < 0, -r5, 0),
  over6, if(r6 < 0, -r6, 0),

  a1, if(r1 < 0, 0, r1),
  a2, if(r2 < 0, 0, r2),
  a3, if(r3 < 0, 0, r3),
  a4, if(r4 < 0, 0, r4),
  a5, if(r5 < 0, 0, r5),
  a6, if(r6 < 0, 0, r6),

  d1, floor(a1 / 5000),
  d2, floor(a2 / 5000),
  d3, floor(a3 / 5000),
  d4, floor(a4 / 5000),
  d5, floor(a5 / 5000),
  d6, floor(a6 / 5000),

  t1, if(a1 == 0, 0, ceil((a1 - d1 * 5000) / 500)),
  t2, if(a2 == 0, 0, ceil((a2 - d2 * 5000) / 500)),
  t3, if(a3 == 0, 0, ceil((a3 - d3 * 5000) / 500)),
  t4, if(a4 == 0, 0, ceil((a4 - d4 * 5000) / 500)),
  t5, if(a5 == 0, 0, ceil((a5 - d5 * 5000) / 500)),
  t6, if(a6 == 0, 0, ceil((a6 - d6 * 5000) / 500)),

  overD1, floor(over1 / 5000),
  overD2, floor(over2 / 5000),
  overD3, floor(over3 / 5000),
  overD4, floor(over4 / 5000),
  overD5, floor(over5 / 5000),
  overD6, floor(over6 / 5000),

  overT1, if(over1 <= 0, 0, if(floor((over1 - overD1 * 5000) / 500) < 1, 1, floor((over1 - overD1 * 5000) / 500))),
  overT2, if(over2 <= 0, 0, if(floor((over2 - overD2 * 5000) / 500) < 1, 1, floor((over2 - overD2 * 5000) / 500))),
  overT3, if(over3 <= 0, 0, if(floor((over3 - overD3 * 5000) / 500) < 1, 1, floor((over3 - overD3 * 5000) / 500))),
  overT4, if(over4 <= 0, 0, if(floor((over4 - overD4 * 5000) / 500) < 1, 1, floor((over4 - overD4 * 5000) / 500))),
  overT5, if(over5 <= 0, 0, if(floor((over5 - overD5 * 5000) / 500) < 1, 1, floor((over5 - overD5 * 5000) / 500))),
  overT6, if(over6 <= 0, 0, if(floor((over6 - overD6 * 5000) / 500) < 1, 1, floor((over6 - overD6 * 5000) / 500))),

  left1, if(over1 > 0, "過", "残"),
  left2, if(over2 > 0, "過", "残"),
  left3, if(over3 > 0, "過", "残"),
  left4, if(over4 > 0, "過", "残"),
  left5, if(over5 > 0, "過", "残"),
  left6, if(over6 > 0, "過", "残"),

  ticket1, if(over1 > 0, style("🎟️" + format(overT1), "red", "b"), "🎟️" + format(t1)),
  ticket2, if(over2 > 0, style("🎟️" + format(overT2), "red", "b"), "🎟️" + format(t2)),
  ticket3, if(over3 > 0, style("🎟️" + format(overT3), "red", "b"), "🎟️" + format(t3)),
  ticket4, if(over4 > 0, style("🎟️" + format(overT4), "red", "b"), "🎟️" + format(t4)),
  ticket5, if(over5 > 0, style("🎟️" + format(overT5), "red", "b"), "🎟️" + format(t5)),
  ticket6, if(over6 > 0, style("🎟️" + format(overT6), "red", "b"), "🎟️" + format(t6)),

  diamond1, if(over1 > 0, style("💎" + format(overD1), "red", "b"), "💎" + format(d1)),
  diamond2, if(over2 > 0, style("💎" + format(overD2), "red", "b"), "💎" + format(d2)),
  diamond3, if(over3 > 0, style("💎" + format(overD3), "red", "b"), "💎" + format(d3)),
  diamond4, if(over4 > 0, style("💎" + format(overD4), "red", "b"), "💎" + format(d4)),
  diamond5, if(over5 > 0, style("💎" + format(overD5), "red", "b"), "💎" + format(d5)),
  diamond6, if(over6 > 0, style("💎" + format(overD6), "red", "b"), "💎" + format(d6)),

  s1, if(budget <= 0, 0, if(a1 / budget >= 1, scale, ceil(a1 / budget * scale))),
  s2, if(budget <= 0, 0, if(a2 / budget >= 1, scale, ceil(a2 / budget * scale))),
  s3, if(budget <= 0, 0, if(a3 / budget >= 1, scale, ceil(a3 / budget * scale))),
  s4, if(budget <= 0, 0, if(a4 / budget >= 1, scale, ceil(a4 / budget * scale))),
  s5, if(budget <= 0, 0, if(a5 / budget >= 1, scale, ceil(a5 / budget * scale))),
  s6, if(budget <= 0, 0, if(a6 / budget >= 1, scale, ceil(a6 / budget * scale))),

  lines, [
    if(weekCount >= 1, if(activeW == 1, style("W1", "b", "blue"), "W1") + "  " + left1 + " " + ticket1 + "  " + diamond1 + "  " + repeat(bar, s1), ""),
    if(weekCount >= 2, if(activeW == 2, style("W2", "b", "blue"), "W2") + "  " + left2 + " " + ticket2 + "  " + diamond2 + "  " + repeat(bar, s2), ""),
    if(weekCount >= 3, if(activeW == 3, style("W3", "b", "blue"), "W3") + "  " + left3 + " " + ticket3 + "  " + diamond3 + "  " + repeat(bar, s3), ""),
    if(weekCount >= 4, if(activeW == 4, style("W4", "b", "blue"), "W4") + "  " + left4 + " " + ticket4 + "  " + diamond4 + "  " + repeat(bar, s4), ""),
    if(weekCount >= 5, if(activeW == 5, style("W5", "b", "blue"), "W5") + "  " + left5 + " " + ticket5 + "  " + diamond5 + "  " + repeat(bar, s5), ""),
    if(weekCount >= 6, if(activeW == 6, style("W6", "b", "blue"), "W6") + "  " + left6 + " " + ticket6 + "  " + diamond6 + "  " + repeat(bar, s6), "")
  ].filter(current != ""),

  legend, "¥500=🎟️/¥5,000=💎（" + style("超過", "red", "b") + "🎟️/💎）",

  if(
    empty(y) or mNum == 0,
    "",
    legend + "\n" + join(lines, "\n")
  )
)
```
