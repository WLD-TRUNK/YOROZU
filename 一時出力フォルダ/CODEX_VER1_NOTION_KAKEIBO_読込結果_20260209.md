# CODEX_VER.1【2024年最新版】Notion家計簿 読込結果（暫定）

> 注意: このファイルはローカル資料ベースの暫定版です。  
> Notion APIで `CODEX_VER.1` 実体を直接読んだ最新版は `一時出力フォルダ/CODEX_VER1_NOTION_KAKEIBO_実体読込結果_20260209.md` を参照してください。

作成日: 2026-02-09

## 0. 読込対象
- `一時出力フォルダ/NOTION_KAKEIBO_RELATION_GUIDE.md`
- `一時出力フォルダ/NOTION_CATEGORY_SYNC_NOTES_20260208.md`
- `一時出力フォルダ/CODEX_KAKEIBO_VER0_CATEGORY_WEEKLY_FORMULA.md`
- `一時出力フォルダ/NOTION_CATEGORY_P_BUDGET_FORMULA_BACKUP_20260208_235418.txt`
- `一時出力フォルダ/sync_category_kakeibo.py`

補足:
- IDEタブにある `tmp_formula_m3.txt` / `tmp_formula_m12.txt` / `tmp_formula_total.txt` は、ワークスペース上の実ファイルとしては確認できなかった。

## 1. ページ構造（DB構造）理解
この家計簿は **中間DBをハブ** にして、支出・収入・月別集計・カテゴリー別集計を接続する設計。

### 1.1 DB一覧（ガイド記載）
- 支出DB: `2f2d8928-02b6-8126-8d37-e1ebd985d759`
- 収入DB: `2f2d8928-02b6-8116-97ba-c39ccb83f913`
- 月別集計DB: `2f2d8928-02b6-81b3-802c-f33a84340c29`
- カテゴリー別集計: `2f2d8928-02b6-81c9-a0d5-e9c6b64fb352`
- 中間DB: `2f2d8928-02b6-81f0-8d7c-ebba1e830552`

### 1.2 リレーション方向
- 中間DB -> カテゴリー別集計
- 中間DB -> 月別集計DB
- 中間DB -> 収入DB
- 中間DB -> 支出DB
- 各DB側にも中間DBへの逆向きリレーションあり

### 1.3 参照ルール（意図）
- リレーション値は配列なので `prop("中間DB").at(0)` で単一化して参照する。
- 集計は `filter -> map -> sum` の3段で統一。
- 年月は `formatDate(..., "YYYY-MM")` または `YYYYM`/`YYYYMM` でキー化。
- API内部IDではなく、Notion UIのプロパティ名ベースで式を維持する。

## 2. 数式の全体構成（意図別）
`NOTION_KAKEIBO_RELATION_GUIDE.md` 上の `notion-formula` ブロックは合計25本。

### 2.1 支出DB（4本）
- `週番号`: 年初基準で週番号文字列（`YYYY-Wxx`）を生成
- `チケット`: 支出を500円単位に丸め（`ceil(支出/500)`）
- `年月キー`: 日付から `YYYY-MM` を作成
- `月内週`: 月初を起点に「第何週か」を算出

意図:
- 後段DBで週次/年月集計しやすい基礎指標を支出行に先に持たせる。

### 2.2 月別集計DB（5本）
- `支出 / 予算`
- `収入合計`
- `支出合計`
- `支出 / 収入`
- `収入 - 支出`

意図:
- 月単位の損益と予算消化率を、支出DB/収入DBから自動集約して可視化する。

### 2.3 カテゴリー別集計（16本）
- 月別式: `1月`〜`12月`（各月のカテゴリ支出合計）
- `合計`（年×カテゴリの合算）
- `週予算`（今月の週ごとのチケット使用量表示）
- `数式 1`（当週の残チケット）
- `集計テーブル`（W1〜W6の残予算表示。1月時は2月1週目を最終週に合算）

意図:
- カテゴリ視点で「月合計」だけでなく「週ペース」を管理する。
- 特に `集計テーブル` は予算超過を週単位で早期検知するための式。

## 3. CODEX_VER.1としての設計意図（読み取り結果）
- `グラフの幅` 参照を `予算金額` に統一し、予算基準を1本化。
- カテゴリー別集計の主要列（`1月`〜`12月`、`合計`、`予算`）を formula 型運用に戻す。
- 値書き込みスクリプト運用ではなく、式運用を主とする方針に切替。
- 複雑な relation 含み式は API 貼り付けで失敗するため、最終反映を Notion UIで行う前提。

## 4. 補助ファイルからの整合確認
- `NOTION_CATEGORY_P_BUDGET_FORMULA_BACKUP_20260208_235418.txt`
  - 同等ロジックの内部ID表記版バックアップ。UI用にはプロパティ名へ戻す必要がある。
- `CODEX_KAKEIBO_VER0_CATEGORY_WEEKLY_FORMULA.md`
  - 旧版メモだが、`予算金額` 基準や週次バー可視化の意図はVER.1と連続している。
- `sync_category_kakeibo.py`
  - 値同期スクリプト。現在方針（式主体）では通常実行不要。

## 5. 最終理解（要約）
このNotion家計簿は、
- 中間DBでデータ接続を単純化し、
- 支出行に週・年月キーを付与して再利用性を上げ、
- 月別集計DBで家計全体の健全性（収支/予算比）を把握し、
- カテゴリー別集計で週次ペースまで管理する
という、**「月次の結果確認」+「週次の先行管理」** を両立する構造になっている。
