# CODEX_VER1 集計テーブル（`月 + 残額 + バー`）修正式

対象: `カテゴリー別集計_P` の `集計テーブル`

```notion-formula
if(
  empty(prop("選択年")),
  "",
  lets(
    /* 実環境基準: 週予算 × 当月週数 = 月予算 */
    y, replaceAll(format(prop("選択年").at(0)), "[^0-9]", ""),
    weekBudget, if(empty(prop("週予算")), 0, prop("週予算")),

    bar, style("　", prop("背景色")),
    scale, 12,

    monthValue, [
      prop("1月"), prop("2月"), prop("3月"), prop("4月"), prop("5月"), prop("6月"),
      prop("7月"), prop("8月"), prop("9月"), prop("10月"), prop("11月"), prop("12月")
    ],
    months, [1,2,3,4,5,6,7,8,9,10,11,12],

    months.map(
      lets(
        m, current,
        mText, if(m < 10, "0" + format(m), format(m)),
        monthStart, parseDate(y + "-" + mText + "-01"),

        /* 日曜起点で当月週数を算出（4/5/6） */
        offsetSun, if(toNumber(formatDate(monthStart, "E")) == 7, 0, toNumber(formatDate(monthStart, "E"))),
        week0Start, dateSubtract(monthStart, offsetSun, "days"),
        monthEnd, dateSubtract(dateAdd(monthStart, 1, "months"), 1, "days"),
        weekCount, floor(dateBetween(monthEnd, week0Start, "days") / 7) + 1,

        monthBudget, weekBudget * weekCount,
        spent, toNumber(monthValue.at(m - 1)),
        remainRaw, monthBudget - spent,
        remainForBar, if(remainRaw < 0, 0, remainRaw),

        barLen,
          if(
            monthBudget <= 0,
            0,
            if(
              remainForBar >= monthBudget,
              scale,
              ceil(remainForBar / monthBudget * scale)
            )
          ),

        monthLabel, if(m < 10, "  " + format(m), format(m)),
        monthLabel + "月  残 " + format(remainRaw) + "円  " + repeat(bar, barLen)
      )
    ).join("\n")
  )
)
```

## メモ
- `選択年` と `週予算` を実環境プロパティとして使用。
- 予算超過時（残額がマイナス）は、残額はマイナス表示・バーは0本になる。
