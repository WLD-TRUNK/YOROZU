# カテゴリー別集計_P 「年合計」修正式

対象: `カテゴリー別集計_P` の `年合計`（formula）

## 置換用数式（元形式準拠）
`lets + filter + map + sum` の元形式を維持しつつ、`YYYY`（文字列）と `選択年` の型をそろえています。

```notion-formula
if(
  empty(prop("中間DB")),
  0,
  lets(
    outcome, prop("中間DB").at(0).prop("支出一覧"),
    targetYear, replaceAll(format(prop("選択年").at(0)), "[^0-9]", ""),
    targetCategory, prop("名前"),

    total,
      outcome.filter(
        formatDate(current.prop("日付"), "YYYY") == targetYear
        and current.prop("カテゴリー") == targetCategory
      ),

    total.map(current.prop("支出")).sum()
  )
)
```

## 意図
- 元の集計ロジック（支出一覧を直接集計）を維持する
- `formatDate(..., "YYYY")` と `選択年` の型差異による不一致を回避する

## 補足
- `選択年` は既存月別式と同様に `replaceAll(format(prop("選択年").at(0)), "[^0-9]", "")` で年文字列化しています。
- 合計は `total.map(...).sum()`（既存月別式と同じメソッド型）を使用しています。
