# CODEX_VER1 é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ« æ­£å¼ç‰ˆï¼ˆå‡¡ä¾‹ + å½“é€±Wè‰²å¼·èª¿ï¼‰

å¯¾è±¡: `ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥é›†è¨ˆ_P` ã® `é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«`

ä»•æ§˜:
- å…ˆé ­ã«å‡¡ä¾‹ `Â¥500=ğŸŸï¸/Â¥5,000=ğŸ’` ã‚’è¡¨ç¤º
- é¸æŠä¸­ã® `å¹´/æœˆ` ãŒä»Šæœˆã¨ä¸€è‡´ã™ã‚‹å ´åˆã€å½“é€±ã® `W` ãƒ©ãƒ™ãƒ«ã®ã¿èµ¤å¤ªå­—ã§å¼·èª¿

```notion-formula
lets(
  outcome, prop("ä¸­é–“DB").at(0).prop("æ”¯å‡ºä¸€è¦§"),
  y, replaceAll(format(prop("é¸æŠå¹´").at(0)), "[^0-9]", ""),
  mNum, toNumber(replaceAll(format(prop("é¸æŠæœˆ").at(0)), "[^0-9]", "")),
  mText, if(mNum == 0, "", if(mNum < 10, "0" + format(mNum), format(mNum))),
  budget, if(empty(prop("é€±äºˆç®—")), 0, prop("é€±äºˆç®—")),
  bar, style("ã€€", prop("èƒŒæ™¯è‰²")),
  scale, 10,

  ym, y + "-" + mText,
  febYm, y + "-02",
  monthStart, parseDate(ym + "-01"),
  offsetSun, if(toNumber(formatDate(monthStart, "E")) == 7, 0, toNumber(formatDate(monthStart, "E"))),
  week0StartM, dateSubtract(monthStart, offsetSun, "days"),
  nextMonthStart, dateAdd(monthStart, 1, "months"),
  monthEnd, dateSubtract(nextMonthStart, 1, "days"),
  weekCount, floor(dateBetween(monthEnd, week0StartM, "days") / 7) + 1,

  nowD, now(),
  nowMonthStart, dateSubtract(nowD, toNumber(formatDate(nowD, "D")) - 1, "days"),
  nowOffsetSun, if(toNumber(formatDate(nowMonthStart, "E")) == 7, 0, toNumber(formatDate(nowMonthStart, "E"))),
  nowWeek0Start, dateSubtract(nowMonthStart, nowOffsetSun, "days"),
  wNow, floor(dateBetween(nowD, nowWeek0Start, "days") / 7) + 1,
  activeW, if(formatDate(nowD, "YYYY-MM") == ym, wNow, 0),

  w1, outcome.filter(
    formatDate(current.prop("æ—¥ä»˜"), "YYYY-MM") == ym
    and current.prop("ã‚«ãƒ†ã‚´ãƒªãƒ¼") == prop("åå‰")
    and lets(
      d, current.prop("æ—¥ä»˜"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 1
  ).map(current.prop("æ”¯å‡º")).sum(),

  w2, outcome.filter(
    formatDate(current.prop("æ—¥ä»˜"), "YYYY-MM") == ym
    and current.prop("ã‚«ãƒ†ã‚´ãƒªãƒ¼") == prop("åå‰")
    and lets(
      d, current.prop("æ—¥ä»˜"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 2
  ).map(current.prop("æ”¯å‡º")).sum(),

  w3, outcome.filter(
    formatDate(current.prop("æ—¥ä»˜"), "YYYY-MM") == ym
    and current.prop("ã‚«ãƒ†ã‚´ãƒªãƒ¼") == prop("åå‰")
    and lets(
      d, current.prop("æ—¥ä»˜"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 3
  ).map(current.prop("æ”¯å‡º")).sum(),

  w4, outcome.filter(
    formatDate(current.prop("æ—¥ä»˜"), "YYYY-MM") == ym
    and current.prop("ã‚«ãƒ†ã‚´ãƒªãƒ¼") == prop("åå‰")
    and lets(
      d, current.prop("æ—¥ä»˜"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 4
  ).map(current.prop("æ”¯å‡º")).sum(),

  w5, outcome.filter(
    formatDate(current.prop("æ—¥ä»˜"), "YYYY-MM") == ym
    and current.prop("ã‚«ãƒ†ã‚´ãƒªãƒ¼") == prop("åå‰")
    and lets(
      d, current.prop("æ—¥ä»˜"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 5
  ).map(current.prop("æ”¯å‡º")).sum(),

  w6, outcome.filter(
    formatDate(current.prop("æ—¥ä»˜"), "YYYY-MM") == ym
    and current.prop("ã‚«ãƒ†ã‚´ãƒªãƒ¼") == prop("åå‰")
    and lets(
      d, current.prop("æ—¥ä»˜"),
      monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
      offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
      week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
      floor(dateBetween(d, week0Start, "days") / 7) + 1
    ) == 6
  ).map(current.prop("æ”¯å‡º")).sum(),

  febW1, if(
    mNum == 1,
    outcome.filter(
      formatDate(current.prop("æ—¥ä»˜"), "YYYY-MM") == febYm
      and current.prop("ã‚«ãƒ†ã‚´ãƒªãƒ¼") == prop("åå‰")
      and lets(
        d, current.prop("æ—¥ä»˜"),
        monthStartD, dateSubtract(d, toNumber(formatDate(d, "D")) - 1, "days"),
        offsetSunD, if(toNumber(formatDate(monthStartD, "E")) == 7, 0, toNumber(formatDate(monthStartD, "E"))),
        week0Start, dateSubtract(monthStartD, offsetSunD, "days"),
        floor(dateBetween(d, week0Start, "days") / 7) + 1
      ) == 1
    ).map(current.prop("æ”¯å‡º")).sum(),
    0
  ),

  w4Adj, if(mNum == 1 and weekCount == 4, w4 + febW1, w4),
  w5Adj, if(mNum == 1 and weekCount == 5, w5 + febW1, w5),
  w6Adj, if(mNum == 1 and weekCount == 6, w6 + febW1, w6),

  r1, budget - w1,
  r2, budget - w2,
  r3, budget - w3,
  r4, budget - w4Adj,
  r5, budget - w5Adj,
  r6, budget - w6Adj,

  a1, if(r1 < 0, 0, r1),
  a2, if(r2 < 0, 0, r2),
  a3, if(r3 < 0, 0, r3),
  a4, if(r4 < 0, 0, r4),
  a5, if(r5 < 0, 0, r5),
  a6, if(r6 < 0, 0, r6),

  d1, floor(a1 / 5000),
  d2, floor(a2 / 5000),
  d3, floor(a3 / 5000),
  d4, floor(a4 / 5000),
  d5, floor(a5 / 5000),
  d6, floor(a6 / 5000),

  t1, if(a1 == 0, 0, ceil((a1 - d1 * 5000) / 500)),
  t2, if(a2 == 0, 0, ceil((a2 - d2 * 5000) / 500)),
  t3, if(a3 == 0, 0, ceil((a3 - d3 * 5000) / 500)),
  t4, if(a4 == 0, 0, ceil((a4 - d4 * 5000) / 500)),
  t5, if(a5 == 0, 0, ceil((a5 - d5 * 5000) / 500)),
  t6, if(a6 == 0, 0, ceil((a6 - d6 * 5000) / 500)),

  s1, if(budget <= 0, 0, if(a1 / budget >= 1, scale, ceil(a1 / budget * scale))),
  s2, if(budget <= 0, 0, if(a2 / budget >= 1, scale, ceil(a2 / budget * scale))),
  s3, if(budget <= 0, 0, if(a3 / budget >= 1, scale, ceil(a3 / budget * scale))),
  s4, if(budget <= 0, 0, if(a4 / budget >= 1, scale, ceil(a4 / budget * scale))),
  s5, if(budget <= 0, 0, if(a5 / budget >= 1, scale, ceil(a5 / budget * scale))),
  s6, if(budget <= 0, 0, if(a6 / budget >= 1, scale, ceil(a6 / budget * scale))),

  lines, [
    if(weekCount >= 1, if(activeW == 1, style("W1", "b", "red"), "W1") + "  æ®‹ğŸŸï¸" + format(t1) + "  ğŸ’" + format(d1) + "  " + repeat(bar, s1), ""),
    if(weekCount >= 2, if(activeW == 2, style("W2", "b", "red"), "W2") + "  æ®‹ğŸŸï¸" + format(t2) + "  ğŸ’" + format(d2) + "  " + repeat(bar, s2), ""),
    if(weekCount >= 3, if(activeW == 3, style("W3", "b", "red"), "W3") + "  æ®‹ğŸŸï¸" + format(t3) + "  ğŸ’" + format(d3) + "  " + repeat(bar, s3), ""),
    if(weekCount >= 4, if(activeW == 4, style("W4", "b", "red"), "W4") + "  æ®‹ğŸŸï¸" + format(t4) + "  ğŸ’" + format(d4) + "  " + repeat(bar, s4), ""),
    if(weekCount >= 5, if(activeW == 5, style("W5", "b", "red"), "W5") + "  æ®‹ğŸŸï¸" + format(t5) + "  ğŸ’" + format(d5) + "  " + repeat(bar, s5), ""),
    if(weekCount >= 6, if(activeW == 6, style("W6", "b", "red"), "W6") + "  æ®‹ğŸŸï¸" + format(t6) + "  ğŸ’" + format(d6) + "  " + repeat(bar, s6), "")
  ].filter(current != ""),

  legend, "Â¥500=ğŸŸï¸/Â¥5,000=ğŸ’",

  if(
    empty(y) or mNum == 0,
    "",
    legend + "\n" + join(lines, "\n")
  )
)
```

## è£œè¶³
- ä»Šæœˆä»¥å¤–ï¼ˆéå»æœˆ/æœªæ¥æœˆï¼‰ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã¨ãã¯ `activeW = 0` ã¨ãªã‚Šã€Wãƒ©ãƒ™ãƒ«ã¯é€šå¸¸è¡¨ç¤ºã®ã¾ã¾ã§ã™ã€‚
